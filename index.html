<!DOCTYPE html>
<html>
<head>
    <title>traintable</title>
    <style type="text/css" media="screen">
        body {
            align: center;
            margin: 0;
        }

        #content {
            width: 600px;
            height: 1wh;
            margin: auto;
            background-color: #fff;
        }

        svg {
            border: 1px solid black
        }

        path {
            stroke: #633;
            stroke-opacity: 0.5;
            stroke-width: 10px;
        }

        th {
            width: 80px;
        }
    </style>
    <script type="text/javascript" src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.2/raphael-min.js" charset="utf-8"></script>
</head>
<body>
    <div id="content">
        <h1>traintable</h1>
    </div>

    <script type="text/javascript">
        var days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
        var daysShort = days.map(function(s) { return s.substring(0,3); });
        var data = [];
        for (var i=0; i<7; i++) { data[i] = []; }

        getData(function(info) {
            parseData(info);
            displayData();
        });

        //A test function that doesn't rely on AJAX so I can test locally
        //This will be replaces with $.ajax once the rest is working
        function getData(callback) {
            console.log('fetching data')
            var info = '';
            for (i = 0; i < 100; i++) {
                info += daysShort[(Math.random()*7)|0] + ' '
                      + ((Math.random()*24)|0) + ':' + ((Math.random()*60)|0)
                      + '\n';
            }
            callback(info);
        }

        function parseData(info) {
            console.log('parsing');
            var index = {};
            for (i=0; i<7; i++) {
                index[daysShort[i]] = i;
            }

            var lines = info.split('\n');
            lines.pop();

            for (i=0; i<lines.length; i++) {
                var match = lines[i].match(/^(\S{3}) (\d\d?)\:(\d\d?)$/);
                data[index[match[1]]].push(+match[2]*60 + +match[3]);
            }
        }

        function displayData(){
            console.log('displaying');
            var $table = $('<table>');
            $('#content').append($table);

            var $firstRow = $('<tr>');
            for (i=0; i<7; i++) {
                $firstRow.append('<th>' + days[i] + '</th>');
            }
            $table.append($firstRow);

            var $dataRow = $('<tr id="data">');
            for (i=0; i<7; i++) {
                var $dataCell = $('<td>');
                $dataRow.append($dataCell);
                var paper = Raphael($dataCell[0], 75, 500);
                $dataCell.append(paper);

                data[i].forEach(function(d) {
                    var pos = d * 500 / 1440;
                    paper.path('M0,' + pos + 'L75,' + pos);
                });
            }
            $table.append($dataRow);
        }
    </script>
</body>
</html>
